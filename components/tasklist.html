<div id="tasklist" hidden>
  <div>
    {{#days}}
      <h2>{{name}}</h2>
      <span class="tasks">
        {{#tasks}}
          <span>{{{ . }}}</span>
        {{/tasks}}
      </span>
    {{/days}}
  </div>
</div>

<script>
let days = ['today', 'tomorrow'];
let element = document.querySelector('#tasklist');
let template = element.innerHTML + '';
let state = {
  tasks: [],
};
var TaskList = {
  state,
  render() {
    let daysHTML = days.map(name => {
      return {
        name,
        tasks: [],
      }
    })
    for (let x of state.tasks) {
      let holder = daysHTML.find(o => o.name.toLowerCase() == x.day.toLowerCase());
      if (holder) {
        holder.tasks.push(x);
      }
    }
    for (let x of daysHTML) {
      x.tasks.sort((a, b) => Number(b.id) - Number(a.id))
      x.tasks = x.tasks.map(o => o.render())
    }
    element.innerHTML = Mustache.render(template, {
      days: daysHTML,
    })
    for (let x of state.tasks) {
      x.hook($('#task-' + x.id))
    }
    element.removeAttribute('hidden');
  },
  update(task) {
    console.log('PUSHING CHANGE TO SERVER', task.data);
    fetch('/api/tasks', {
      method: 'PUT',
      headers: {
        'Content-Type': "application/json; charset=utf-8",
      },
      body: JSON.stringify(task.data),
    })
    this.render();
  },
  load() {
    let { render } = this;
    fetch('/api/tasks').then(res => res.json()).then(({ tasks }) => {
      state.tasks = tasks.map(o => {
        return new Task(o);
      })
      render();
    })
  }
}

TaskList.load();
</script>
